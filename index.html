<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cu·ªôc thi Em Y√™u Bi·ªÉn ƒê·∫£o Qu√™ H∆∞∆°ng</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- PRELOAD ·∫¢NH CH·ª®NG NH·∫¨N ƒê·ªÇ LOAD NHANH -->
    <link rel="preload" as="image" href="https://lh3.googleusercontent.com/d/1HCIrAhA-wIkLi-JeMf7LcITm32RRVjQF">
    
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&subset=vietnamese&family=Dancing+Script:wght@700&family=Great+Vibes&family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { 
            --primary: #002855; 
            --blue-sea: #0091ea; 
            --yellow: #fdd835; 
            --text-dark: #333; 
            --bg-gray: #f4f7f6;
        }
        body { font-family: 'Roboto', sans-serif; margin: 0; padding: 0; background: var(--bg-gray); color: var(--text-dark); display: flex; flex-direction: column; min-height: 100vh; }
        
        #font-preload { font-family: 'Oswald', sans-serif; opacity: 0; position: absolute; z-index: -1; pointer-events: none; }
        #font-preload-2 { font-family: 'Great Vibes', cursive; opacity: 0; position: absolute; z-index: -1; pointer-events: none; }

        /* M√ÄN H√åNH CH√ÄO */
        #welcome-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #0288d1 0%, #003c8f 70%, #001a38 100%);
            z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; text-align: center;
            transition: opacity 0.5s ease, visibility 0.5s;
            padding: 20px; box-sizing: border-box;
        }
        .welcome-logo { 
            height: 160px; margin: 0 25px 30px 25px; 
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5)); 
            transition: transform 0.3s; 
        }
        .welcome-logo:hover { transform: scale(1.1); }
        
        .welcome-title {
            font-family: 'Oswald', sans-serif; 
            font-size: 3.8rem; font-weight: 900;
            text-transform: uppercase; line-height: 1.2; margin-bottom: 15px; max-width: 1000px;
            background: linear-gradient(to bottom, #fff 10%, #fdd835 60%, #fbc02d 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.6)); letter-spacing: 3px;
        }
        .welcome-subtitle { 
            font-size: 1.4rem; margin-bottom: 60px; opacity: 0.95; 
            font-weight: 300; letter-spacing: 1px; text-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .welcome-btn {
            background: linear-gradient(to right, #fdd835, #f57f17); color: #002855; 
            padding: 18px 70px; font-size: 1.9rem; font-weight: 900; border: none; border-radius: 60px; 
            cursor: pointer; box-shadow: 0 0 40px rgba(253, 216, 53, 0.5);
            animation: pulseBtn 2s infinite; text-transform: uppercase; font-family: 'Oswald', sans-serif;
            letter-spacing: 2px; border: 3px solid rgba(255,255,255,0.8);
        }
        @keyframes pulseBtn { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(253, 216, 53, 0.7); } 70% { transform: scale(1.05); box-shadow: 0 0 0 25px rgba(253, 216, 53, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(253, 216, 53, 0); } }

        header { 
            padding: 12px 5%; display: flex; justify-content: space-between; align-items: center; 
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            position: sticky; top: 0; z-index: 5000; box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
        }
        .logo-area { display: flex; align-items: center; gap: 15px; cursor: pointer; }
        .logo-area img { height: 55px; }
        .logo-text h1 { margin: 0; color: #002855; font-size: 1.2rem; font-weight: 900; text-transform: uppercase; }
        .nav-right { display: flex; align-items: center; gap: 15px; }
        .nav-link { text-decoration: none; color: #002855; font-weight: 700; cursor: pointer; text-transform: uppercase; font-size: 0.95rem; transition:0.3s; }
        .btn-header { background: var(--yellow); border: none; padding: 10px 25px; border-radius: 30px; font-weight: 900; cursor: pointer; box-shadow: 0 4px #fbc02d; color: var(--primary); transition: 0.2s; font-family: 'Roboto', sans-serif; }
        .btn-header:active { transform: translateY(2px); box-shadow: 0 2px #fbc02d; }
        
        #music-btn { width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--blue-sea); background: white; color: var(--blue-sea); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; transition: 0.3s; z-index: 5001; }
        #music-btn.playing { background: var(--blue-sea); color: white; animation: rotateMusic 4s infinite linear; }
        @keyframes rotateMusic { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #hero { background: linear-gradient(135deg, #0288d1 0%, #01579b 100%); padding: 50px 20px 120px; text-align: center; color: white; position: relative; overflow: hidden; }
        .hero-logos { display: flex; justify-content: center; gap: 20px; margin-bottom: 25px; align-items: center; }
        .hero-logo-img { height: 110px; object-fit: contain; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.3)); }
        .year-pill { display: inline-block; border: 1px solid rgba(255,255,255,0.4); background: rgba(255,255,255,0.1); padding: 8px 30px; border-radius: 50px; font-size: 1rem; margin-bottom: 20px; letter-spacing: 1px; }
        .hero-title-1 { font-size: 4rem; font-weight: 900; margin: 0; line-height: 1; text-shadow: 0 5px 15px rgba(0,0,0,0.3); font-family: 'Oswald', sans-serif; }
        .hero-title-2 { font-size: 4rem; font-weight: 900; margin: 5px 0 30px; color: var(--yellow); text-shadow: 0 5px 15px rgba(0,0,0,0.3); font-family: 'Oswald', sans-serif; }
        .hero-desc { max-width: 700px; margin: 0 auto 40px; font-size: 1.2rem; opacity: 0.9; line-height: 1.6; }
        .btn-register { font-family: 'Roboto', 'Arial', sans-serif; font-size: 22px; font-weight: 900; background: linear-gradient(to bottom, #fdd835, #f9a825); padding: 15px 50px; border: none; border-radius: 50px; cursor: pointer; box-shadow: 0 8px 20px rgba(0,0,0,0.3); transition: 0.2s; color: #002855; text-transform: uppercase; }
        .btn-register:hover { transform: translateY(-3px); box-shadow: 0 12px 25px rgba(0,0,0,0.4); }
        .wave-bottom { position: absolute; bottom: -1px; left: 0; width: 100%; line-height: 0; }
        .wave-bottom svg { width: 100%; height: 90px; fill: #f4f7f6; }

        .cards-section { padding: 0 20px; margin-top: -60px; position: relative; z-index: 2; display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
        .info-card { background: #fff; width: 240px; padding: 20px 15px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); text-align: center; border-top: 4px solid transparent; transition: transform 0.3s; }
        .info-card.blue-theme { border-top-color: #1565c0; }
        .info-card.pink-theme { border-top-color: #c2185b; }
        .info-card.yellow-theme { border-top-color: #fbc02d; }
        .info-card:hover { transform: translateY(-5px); }
        .icon-circle { width: 55px; height: 55px; background: #e3f2fd; color: #1565c0; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; margin: 0 auto 10px; }
        .icon-circle.pink { background: #fce4ec; color: #c2185b; }
        .icon-circle.yellow { background: #fffde7; color: #fbc02d; }
        .card-num { font-size: 1.8rem; font-weight: 700; color: #333; margin-bottom: 2px; font-family: 'Oswald', sans-serif; }
        .card-label { font-size: 0.9rem; color: #666; font-weight: 500; }
        
        .stats-container { max-width: 1100px; margin: 50px auto; padding: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; }
        .stat-box { background: #fff; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); padding: 25px; border: 1px solid #eee; }
        .stat-title { text-align: center; color: #002855; font-weight: 900; text-transform: uppercase; margin-bottom: 15px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; font-size: 1.1rem; }
        
        .rank-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        .rank-table td { padding: 10px; border-bottom: 1px solid #f5f5f5; color: #555; }
        .rank-badge { padding: 3px 8px; border-radius: 10px; font-size: 0.8rem; font-weight: 700; display:inline-block; min-width:20px; text-align:center; }
        .rank-1 .rank-badge { background: #FFD700; color: #fff; box-shadow: 0 2px 5px rgba(255, 215, 0, 0.4); } 
        .rank-2 .rank-badge { background: #C0C0C0; color: #fff; } 
        .rank-3 .rank-badge { background: #CD7F32; color: #fff; } 
        .rank-other .rank-badge { background: #e3f2fd; color: #002855; }

        #quiz-view { display: none; max-width: 900px; margin: 40px auto; padding: 0; border-radius: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); background: url('https://drive.google.com/uc?export=download&id=1AxwtzPQkPPSupZZ6_rGTo1zneI0ualy2') no-repeat center center; background-size: cover; overflow: hidden; position: relative; min-height: 550px; }
        .quiz-glass-panel { background: rgba(255, 255, 255, 0.93); backdrop-filter: blur(10px); margin: 30px; padding: 30px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0, 40, 85, 0.2); border: 1px solid rgba(255, 255, 255, 0.6); }
        .option-btn { display: block; width: 100%; text-align: left; padding: 15px 20px; margin-bottom: 12px; border: 2px solid #eef2f5; border-radius: 12px; cursor: pointer; transition: all 0.25s ease; background: #fff; font-size: 1.05rem; color: #444; font-weight: 500; }
        .option-btn:hover { background: #f0f9ff; border-color: #0091ea; transform: translateX(5px); }
        .option-btn.selected { background: #002855; color: white; border-color: #002855; box-shadow: 0 5px 15px rgba(0, 40, 85, 0.3); }

        #chatbot-widget { position: fixed; bottom: 30px; right: 30px; z-index: 3000; display: none; }
        #chat-toggle { width: 85px; height: 85px; border-radius: 50%; background: #fff; box-shadow: 0 5px 25px rgba(0,0,0,0.4); cursor: pointer; border: 4px solid #fff; overflow: hidden; transition: transform 0.3s; }
        #chat-toggle:hover { transform: scale(1.1); }
        #chat-toggle img { width: 100%; height: 100%; object-fit: cover; }
        #chat-window { display: none; position: absolute; bottom: 100px; right: 0; width: 350px; height: 480px; background: #fff; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); flex-direction: column; overflow: hidden; border: 1px solid #eee; }
        .chat-header { background: #002855; color: white; padding: 15px; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .chat-header img { width: 45px; height: 45px; border-radius: 50%; border: 2px solid white; object-fit: cover; }
        .chat-close { margin-left: auto; cursor: pointer; font-size: 1.2rem; }
        .chat-body { flex: 1; padding: 15px; overflow-y: auto; background: #f9fcff; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 85%; padding: 10px 15px; border-radius: 15px; font-size: 0.95rem; line-height: 1.5; word-wrap: break-word; }
        .msg-bot { background: #e3f2fd; align-self: flex-start; border-bottom-left-radius: 2px; color: #333; }
        .msg-user { background: #002855; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-footer { padding: 12px; border-top: 1px solid #eee; display: flex; gap: 8px; align-items: center; }
        .chat-input { flex: 1; padding: 10px 15px; border: 1px solid #ddd; border-radius: 25px; outline: none; }
        .chat-btn { background: #002855; color: white; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 0.9rem; }
        
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .popup { background: #fff; padding: 30px; width: 90%; max-width: 900px; border-radius: 20px; position: relative; animation: slideIn 0.3s; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.4); }
        @keyframes slideIn { from {transform: translateY(-20px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        
        .intro-content h2 { text-align: center; color: #002855; margin-bottom: 20px; font-size: 1.6rem; border-bottom: 2px solid #fdd835; padding-bottom: 10px; display: inline-block; font-family: 'Oswald', sans-serif; }
        .intro-logos { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; }
        .intro-logo-img { height: 80px; object-fit: contain; }
        .intro-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px; }
        .intro-section-title { color: #002855; font-weight: 800; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; font-size: 1.1rem; text-transform: uppercase; background: #e3f2fd; padding: 6px 12px; border-radius: 8px; }
        .intro-list { padding-left: 20px; margin: 0; }
        .intro-list li { margin-bottom: 8px; line-height: 1.5; font-size: 0.95rem; color: #444; }

        .close-btn { position: absolute; top: 15px; right: 20px; cursor: pointer; font-size: 1.8rem; color: #999; }
        .form-control { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn-full { width: 100%; background: #002855; color: white; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 2000; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s; }
        #result-view { display: none; max-width: 800px; margin: 40px auto; padding: 30px; background: #fff; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        canvas { display: none; width: 100%; height: auto; border: 5px solid #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.2); margin-top: 20px; }
        #cert-final { width: 100%; border: 5px solid #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.2); margin-top: 20px; display: none; }

        footer { background: #001a38; color: white; padding: 30px 20px; text-align: center; margin-top: auto; border-top: 5px solid #fdd835; }
        .footer-content { max-width: 1100px; margin: 0 auto; display: flex; flex-direction: column; gap: 10px; align-items: center; }
        .footer-content p { margin: 0; font-size: 0.9rem; opacity: 0.9; }
        .footer-highlight { color: var(--yellow); font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        .social-links { display: flex; gap: 15px; margin-top: 5px; flex-wrap: wrap; justify-content: center; }
        .fb-link { display: inline-flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.1); color: white; text-decoration: none; padding: 8px 20px; border-radius: 25px; font-size: 0.85rem; transition: 0.3s; border: 1px solid rgba(255,255,255,0.2); }
        .fb-link:hover { background: var(--blue-sea); border-color: var(--blue-sea); }

        @media (max-width: 768px) { 
            .welcome-title { font-size: 2.5rem; } 
            .welcome-logo { height: 120px; margin: 0 10px 20px 10px; }
            .intro-grid { grid-template-columns: 1fr; }
            .hero-title-1, .hero-title-2 { font-size: 2.5rem; } 
            .nav-link { display: none; } 
            #chat-window { width: 300px; right: -10px; bottom: 100px; } 
            .quiz-glass-panel { margin: 15px; padding: 20px; }
        }
    </style>
</head>
<body>

    <div id="font-preload">TEST FONT ∆Ø ∆† √Å ·ªä</div>
    <div id="font-preload-2">Nguy·ªÖn VƒÉn A</div>

    <div id="welcome-screen">
        <div class="hero-logos">
            <img src="https://lh3.googleusercontent.com/d/1wkVL6p7qxWY6Ny6lFGcJlOZmurPWcbHt" alt="Logo 1" class="welcome-logo">
            <img src="https://lh3.googleusercontent.com/d/1AKL6--tLvgF13WgCasRSl6fKtCpP4LmL" alt="Logo 2" class="welcome-logo">
        </div>
        <h1 class="welcome-title">CH√ÄO M·ª™NG B·∫†N ƒê·∫æN V·ªöI CU·ªòC THI<br>EM Y√äU BI·ªÇN ƒê·∫¢O QU√ä H∆Ø∆†NG</h1>
        <p class="welcome-subtitle">Kh∆°i d·∫≠y t√¨nh y√™u bi·ªÉn ƒë·∫£o - B·∫£o v·ªá ch·ªß quy·ªÅn thi√™ng li√™ng c·ªßa T·ªï qu·ªëc</p>
        <button class="welcome-btn" onclick="enterSite()">B·∫§M ƒê·ªÇ V√ÄO THI</button>
    </div>

    <audio id="bg-audio" loop preload="auto">
        <source src="https://docs.google.com/uc?export=download&id=1NXOxVD3ralb7zxVWJYtfs6HzVjObn4L-" type="audio/mp3">
    </audio>

    <div id="loader"><i class="fas fa-spinner fa-spin fa-3x" style="color:var(--primary)"></i></div>

    <header>
        <div class="logo-area" onclick="goHome()">
            <img id="logo-img" src="https://lh3.googleusercontent.com/d/1pHh3j1iCQ85q41FP-wKOVOy1iPhW6ace" alt="Logo">
            <div class="logo-text"><h1>EM Y√äU BI·ªÇN ƒê·∫¢O</h1><span>QU√ä H∆Ø∆†NG</span></div>
        </div>
        <div class="nav-right">
            <span class="nav-link" onclick="goHome()">TRANG CH·ª¶</span>
            <span class="nav-link" onclick="document.getElementById('intro-overlay').style.display='flex'">GI·ªöI THI·ªÜU</span>
            <button id="music-btn" onclick="toggleMusic(event)"><i class="fas fa-volume-mute" id="music-icon"></i></button>
            <button class="btn-header" onclick="startTrial()">THI TH·ª¨ NGAY</button>
        </div>
    </header>

    <div id="landing-page">
        <div id="hero">
            <div class="hero-logos">
                <img src="https://lh3.googleusercontent.com/d/1wkVL6p7qxWY6Ny6lFGcJlOZmurPWcbHt" alt="Logo 1" class="hero-logo-img">
                <img src="https://lh3.googleusercontent.com/d/1AKL6--tLvgF13WgCasRSl6fKtCpP4LmL" alt="Logo 2" class="hero-logo-img">
            </div>
            <div class="year-pill">Cu·ªôc thi tr·ª±c tuy·∫øn nƒÉm 2025</div>
            <h1 class="hero-title-1">EM Y√äU</h1>
            <h2 class="hero-title-2">BI·ªÇN ƒê·∫¢O QU√ä H∆Ø∆†NG</h2>
            <p class="hero-desc">C√πng t√¨m hi·ªÉu v·ªÅ l·ªãch s·ª≠, ƒë·ªãa l√Ω v√† ch·ªß quy·ªÅn bi·ªÉn ƒë·∫£o Vi·ªát Nam.</p>
            <button class="btn-register" onclick="document.getElementById('reg-overlay').style.display='flex'">ƒêƒÉng K√Ω D·ª± Thi</button>
            <div class="wave-bottom"><svg viewBox="0 0 1440 320"><path fill="#f4f7f6" d="M0,224L48,213.3C96,203,192,181,288,181.3C384,181,480,203,576,224C672,245,768,267,864,261.3C960,256,1056,224,1152,197.3C1248,171,1344,149,1392,138.7L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg></div>
        </div>

        <div class="cards-section">
            <div class="info-card blue-theme">
                <div class="icon-circle"><i class="fas fa-users"></i></div>
                <div class="card-num" id="s-visits">...</div>
                <div class="card-label">L∆∞·ª£t truy c·∫≠p</div>
            </div>
            <div class="info-card pink-theme">
                <div class="icon-circle pink"><i class="fas fa-school"></i></div>
                <div class="card-num" id="s-schools">...</div>
                <div class="card-label">Tr∆∞·ªùng tham gia</div>
            </div>
            <div class="info-card yellow-theme">
                <div class="icon-circle yellow"><i class="fas fa-trophy"></i></div>
                <div class="card-num" id="s-exams">...</div>
                <div class="card-label">L∆∞·ª£t d·ª± thi</div>
            </div>
        </div>

        <div class="stats-container">
            <h2 style="text-align:center; margin-bottom:40px; color:#333; font-weight:900; font-family:'Oswald',sans-serif; font-size:2rem;">B·∫¢NG X·∫æP H·∫†NG</h2>
            <div class="stats-grid">
                <div class="stat-box"><div class="stat-title">Top 5 T·ªânh/Th√†nh</div><table class="rank-table" id="t-cities"></table></div>
                <div class="stat-box"><div class="stat-title">Top 5 Tr∆∞·ªùng</div><table class="rank-table" id="t-schools"></table></div>
                <div class="stat-box"><div class="stat-title">Top 5 Xu·∫•t S·∫Øc</div><table class="rank-table" id="t-students"></table></div>
            </div>
        </div>
    </div>

    <div id="chatbot-widget">
        <div id="chat-window">
            <div class="chat-header">
                <img src="https://lh3.googleusercontent.com/d/1ozaJRFGUjjIrAd4g54ZTdYLg5TWufo0h" alt="C√¥ B√≠ch">
                <span>C√¥ B√≠ch - H·ªó tr·ª£</span>
                <span class="chat-close" onclick="toggleChat()">&times;</span>
            </div>
            <div class="chat-body" id="chat-body">
                <div class="msg msg-bot">Ch√†o em! C√¥ l√† B√≠ch. C·ªë g·∫Øng l√†m b√†i th·∫≠t t·ªët nh√©! ‚ù§Ô∏è</div>
            </div>
            <div class="chat-footer">
                <input type="text" id="chat-input" class="chat-input" placeholder="H·ªèi c√¥ B√≠ch..." onkeypress="handleChatKey(event)">
                <button class="chat-btn" onclick="sendChat()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
        <div id="chat-toggle" onclick="toggleChat()">
            <img src="https://lh3.googleusercontent.com/d/1ozaJRFGUjjIrAd4g54ZTdYLg5TWufo0h" alt="Chat">
        </div>
    </div>

    <div id="intro-overlay" class="overlay">
        <div class="popup intro-content">
            <span class="close-btn" onclick="this.parentElement.parentElement.style.display='none'">&times;</span>
            <h2>GI·ªöI THI·ªÜU CU·ªòC THI</h2>
            <div class="intro-grid">
                <div>
                    <div class="intro-section-title"><i class="fas fa-info-circle"></i> T·ªïng quan</div>
                    <p style="text-align:justify; line-height:1.6; font-size:0.95rem;">
                        Cu·ªôc thi ‚ÄúEm y√™u bi·ªÉn, ƒë·∫£o Vi·ªát Nam‚Äù l√† ho·∫°t ƒë·ªông tr·ªçng t√¢m n·∫±m trong ƒê·ªÅ √°n 3934 c·ªßa B·ªô Qu·ªëc ph√≤ng v√† k·∫ø ho·∫°ch tri·ªÉn khai c·ªßa C·∫£nh s√°t bi·ªÉn Vi·ªát Nam giai ƒëo·∫°n 2024 ‚Äì 2030. Cu·ªôc thi nh·∫±m gi√°o d·ª•c truy·ªÅn th·ªëng y√™u n∆∞·ªõc, n√¢ng cao hi·ªÉu bi·∫øt ph√°p lu·∫≠t v·ªÅ bi·ªÉn, ƒë·∫£o cho th·∫ø h·ªá tr·∫ª.
                    </p>
                    <div class="intro-section-title"><i class="fas fa-file-alt"></i> CƒÉn c·ª© tri·ªÉn khai</div>
                    <ul class="intro-list">
                        <li>Quy·∫øt ƒë·ªãnh s·ªë 3934/Qƒê-BQP ng√†y 03/9/2024.</li>
                        <li>K·∫ø ho·∫°ch s·ªë 12694/KH-CSB ng√†y 13/11/2024.</li>
                        <li>H∆∞·ªõng d·∫´n s·ªë 13956/HD-BCƒê ng√†y 04/12/2024.</li>
                    </ul>
                </div>
                <div>
                    <div class="intro-section-title"><i class="fas fa-bullseye"></i> M·ª•c ƒë√≠ch</div>
                    <ul class="intro-list">
                        <li>Tuy√™n truy·ªÅn ki·∫øn th·ª©c v·ªÅ l·ªãch s·ª≠, ph√°p lu·∫≠t bi·ªÉn ƒë·∫£o.</li>
                        <li>Ph√≤ng ch·ªëng ma t√∫y, b·∫°o l·ª±c h·ªçc ƒë∆∞·ªùng.</li>
                        <li>X√¢y d·ª±ng l√≤ng y√™u n∆∞·ªõc, tr√°ch nhi·ªám c√¥ng d√¢n.</li>
                    </ul>
                    <div class="intro-section-title"><i class="fas fa-users"></i> Tham gia t·ªï ch·ª©c</div>
                    <ul class="intro-list">
                        <li><strong>ƒêo√†n TNCS H·ªì Ch√≠ Minh C·∫£nh s√°t bi·ªÉn Vi·ªát Nam</strong></li>
                        <li>Ph·ªëi h·ª£p: <strong>H√†nh tr√¨nh s·ªë Vi·ªát Nam My Love</strong></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- KHUNG ƒêƒÇNG K√ù ƒê√É C·∫¨P NH·∫¨T: D√ôNG DROPDOWN T·ªàNH, TR∆Ø·ªúNG L√äN TR√äN -->
    <div id="reg-overlay" class="overlay">
        <div class="popup">
            <span class="close-btn" onclick="this.parentElement.parentElement.style.display='none'">&times;</span>
            <h2 style="color:#002855; text-align:center; margin-bottom:25px;">ƒêƒÇNG K√ù D·ª∞ THI</h2>
            
            <input type="text" id="u-name" class="form-control" placeholder="H·ªç v√† T√™n">
            <input type="text" id="u-class" class="form-control" placeholder="L·ªõp (V√≠ d·ª•: 8A, 5B...)">
            
            <!-- TR∆Ø·ªúNG L√äN TR∆Ø·ªöC -->
            <input type="text" id="u-school" class="form-control" placeholder="Tr∆∞·ªùng / ƒê∆°n v·ªã">
            
            <!-- X√É PH∆Ø·ªúNG -->
            <input type="text" id="u-ward" class="form-control" placeholder="X√£ / Ph∆∞·ªùng">
            
            <!-- DROPDOWN T·ªàNH TH√ÄNH -->
            <select id="u-city" class="form-control" style="background-color: #fff;">
                <option value="" disabled selected>-- Ch·ªçn T·ªânh / Th√†nh ph·ªë --</option>
            </select>

            <button class="btn-full" onclick="startExam(false)">V√ÄO THI NGAY</button>
        </div>
    </div>

    <div id="quiz-view">
        <div class="quiz-glass-panel">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <span style="font-weight:bold; color:#002855; font-size:1.1rem">C√¢u h·ªèi: <b id="q-idx" style="color:#e65100; font-size:1.3rem">1</b>/10</span>
                <span id="mode-label" style="color:#e65100; font-weight:bold; background:rgba(255,255,255,0.8); padding:2px 10px; border-radius:10px;"></span>
            </div>
            <h3 id="q-txt" style="color:#002855; font-size:1.4rem; min-height:60px;">...</h3>
            <div id="options-area" style="margin-top:20px;"></div>
            <div style="text-align:right; margin-top:30px;">
                <button class="btn-header" onclick="nextQ()" style="padding:10px 30px; font-size:1.1rem">Ti·∫øp theo <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>
    </div>

    <div id="result-view" style="text-align:center">
        <h2 style="color:#002855; font-size: 1.8rem; text-transform: uppercase;">C·∫¢M ∆†N EM ƒê√É THAM GIA<br>T√åM HI·ªÇU V·ªÄ BI·ªÇN ƒê·∫¢O QU√ä H∆Ø∆†NG</h2>
        <p style="font-size:1.2rem; margin: 20px 0;">Em tr·∫£ l·ªùi ƒë√∫ng <b id="score-txt" style="color:red; font-size:1.8rem">0</b>/10 c√¢u</p>
        <div id="msg-txt" style="margin-bottom:20px;"></div>
        <canvas id="certCanvas"></canvas> 
        <img id="cert-final">
        <div style="margin-top:20px; display:flex; justify-content:center; gap:10px;">
            <a id="down-btn" class="btn-header" style="text-decoration:none; display:none; background:#fbc02d; color:#002855">T·∫¢I CH·ª®NG NH·∫¨N</a>
            <button class="btn-header" style="background:#e0e0e0; color:#333" onclick="resetApp()">THI L·∫†I</button>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <p>&copy; 2025 Ban Ch·ªâ ƒê·∫°o Cu·ªôc Thi "Em Y√™u Bi·ªÉn ƒê·∫£o Qu√™ H∆∞∆°ng". B·∫£n quy·ªÅn thu·ªôc v·ªÅ C·∫£nh S√°t Bi·ªÉn Vi·ªát Nam.</p>
            <p class="footer-highlight">Ph·ªëi h·ª£p c√¥ng ngh·ªá: H√†nh tr√¨nh s·ªë Vi·ªát Nam My Love</p>
            <div class="social-links">
                <a href="https://www.facebook.com/groups/1801935770443791" target="_blank" class="fb-link">
                    <i class="fab fa-facebook-square"></i> Group C·ªông ƒê·ªìng
                </a>
                <a href="https://www.facebook.com/tuoitrecanhsatbienvietnam" target="_blank" class="fb-link">
                    <i class="fab fa-facebook"></i> Fanpage Tu·ªïi Tr·∫ª CSB
                </a>
            </div>
        </div>
    </footer>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxi-E9yqGfEKIuXTguHY-Th7ajttPkgCKPklJRxu4lRBW6iTcA8_Pt0Rj-ySxpskNlV/exec"; 
        const CERT_BG_URL = "https://lh3.googleusercontent.com/d/1HCIrAhA-wIkLi-JeMf7LcITm32RRVjQF";
        const preloadedCert = new Image();
        preloadedCert.crossOrigin = "Anonymous";

        // DANH S√ÅCH 34 T·ªàNH TH√ÄNH (B·∫°n c√≥ th·ªÉ x√≥a b·ªõt d√≤ng n·∫øu mu·ªën ch·ªâ gi·ªØ 34 t·ªânh)
        const LIST_PROVINCES = [
            "Th√†nh ph·ªë H√† N·ªôi", "Th√†nh ph·ªë H·ªì Ch√≠ Minh", "Th√†nh ph·ªë H·∫£i Ph√≤ng", "Th√†nh ph·ªë ƒê√† N·∫µng", "Th√†nh ph·ªë C·∫ßn Th∆°",
            "T·ªânh H√† Giang", "T·ªânh Cao B·∫±ng", "T·ªânh Lai Ch√¢u", "T·ªânh L√†o Cai", "T·ªânh Tuy√™n Quang", "T·ªânh L·∫°ng S∆°n", "T·ªânh Th√°i Nguy√™n", "T·ªânh S∆°n La", "T·ªânh Ph√∫ Th·ªç", "T·ªânh Qu·∫£ng Ninh", "T·ªânh B·∫Øc Ninh",
            "T·ªânh H∆∞ng Y√™n", "T·ªânh Ninh B√¨nh", "T·ªânh Thanh H√≥a", "T·ªânh Ngh·ªá An", "T·ªânh H√† Tƒ©nh", "T·ªânh Qu·∫£ng Tr·ªã", "T·ªânh Th·ª´a Thi√™n Hu·∫ø",
            "T·ªânh Qu·∫£ng Ng√£i", "T·ªânh Kh√°nh H√≤a", "T·ªânh Gia Lai", "T·ªânh ƒê·∫Øk L·∫Øk",
            "T·ªânh T√¢y Ninh", "T·ªânh ƒê·ªìng Nai", "T·ªânh ƒê·ªìng Th√°p", "T·ªânh An Giang",
            "T·ªânh C√† Mau", "T·ªânh ƒêi·ªán Bi√™n", "T·ªânh Vƒ©nh Long", "T·ªânh L√¢m ƒê·ªìng"
        ];

        const fallbackQuestions = [];

        let questions = [], fullQuestionBank = [];
        let curIdx = 0, score = 0, userAns = null, userInfo = {}, isTrial = false;
        let chatCount = 0;
        let startTime = 0;
        const audio = document.getElementById("bg-audio");
        let musicStarted = false;

        function enterSite() {
            var welcome = document.getElementById('welcome-screen');
            welcome.style.opacity = '0';
            welcome.style.pointerEvents = 'none'; 
            setTimeout(() => { welcome.style.display = 'none'; }, 500);
            playMusicSafe();
        }

        function goHome() {
            document.getElementById('quiz-view').style.display = 'none';
            document.getElementById('result-view').style.display = 'none';
            document.getElementById('reg-overlay').style.display = 'none';
            document.getElementById('intro-overlay').style.display = 'none';
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('landing-page').style.display = 'block';
            if (!musicStarted && audio.paused) { playMusicSafe(); }
        }

        function resetApp() { goHome(); }

        function playMusicSafe() {
            audio.volume = 1.0;
            var promise = audio.play();
            if (promise !== undefined) {
                promise.then(_ => {
                    musicStarted = true;
                    updateMusicBtn(true);
                }).catch(error => { 
                    console.log("Autoplay b·ªã ch·∫∑n, ch·ªù ng∆∞·ªùi d√πng click");
                    updateMusicBtn(false); 
                });
            }
        }

        function toggleMusic(e) { 
            e.stopPropagation(); 
            if (audio.paused) { playMusicSafe(); } else { audio.pause(); updateMusicBtn(false); } 
        }
        
        function updateMusicBtn(isPlaying) { 
            const btn = document.getElementById('music-btn'); 
            const icon = document.getElementById('music-icon'); 
            if (isPlaying) { btn.classList.add('playing'); icon.className = 'fas fa-music'; } else { btn.classList.remove('playing'); icon.className = 'fas fa-volume-mute'; } 
        }

        async function callAPI(action, data = {}) {
            try {
                const response = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify({ action, ...data })
                });
                return await response.json();
            } catch (e) { console.error(e); return null; }
        }

        window.onload = function() {
            preloadedCert.src = CERT_BG_URL;

            // ƒêI·ªÄN DANH S√ÅCH T·ªàNH V√ÄO DROPDOWN
            const citySelect = document.getElementById('u-city');
            // S·∫Øp x·∫øp danh s√°ch t·ªânh theo ABC
            LIST_PROVINCES.sort((a, b) => a.localeCompare(b));
            
            LIST_PROVINCES.forEach(city => {
                let opt = document.createElement('option');
                opt.value = city; 
                opt.innerText = city; 
                citySelect.appendChild(opt);
            });

            setTimeout(() => { 
                document.getElementById('loader').style.opacity = '0';
                setTimeout(() => { document.getElementById('loader').style.display = 'none'; }, 500);
            }, 800); 

            document.fonts.load('400 110px "Great Vibes"');
            document.fonts.load('700 60px "Oswald"');
            
            callAPI("getInitData").then(data => {
                if (data) {
                    if (data.examQuestions && data.examQuestions.length > 0) questions = data.examQuestions;
                    if (data.fullBank) fullQuestionBank = data.fullBank;
                    const safeStats = data.stats || { visits:0, schools:0, exams:0, top_cities:[], top_schools:[], top_students:[] };
                    renderStats(safeStats);
                } else {
                    renderStats({ visits:0, schools:0, exams:0, top_cities:[], top_schools:[], top_students:[] });
                }
            });
        };

        function toggleChat() { const win = document.getElementById('chat-window'); win.style.display = (win.style.display === 'flex') ? 'none' : 'flex'; }
        function handleChatKey(e) { if (e.key === 'Enter') sendChat(); }
        function sendChat() { 
            const input = document.getElementById('chat-input'); 
            const msg = input.value.trim(); 
            if (!msg) return; 
            chatCount++; 
            addMsg(msg, 'user'); 
            input.value = ''; 
            setTimeout(() => { const response = findSmartAnswer(msg); addMsg(response.text, 'bot'); }, 600); 
        }
        function addMsg(text, type) { 
            const body = document.getElementById('chat-body'); 
            const div = document.createElement('div'); 
            div.className = `msg msg-${type}`; 
            div.innerHTML = text; 
            body.appendChild(div); body.scrollTop = body.scrollHeight; 
        }
        function findSmartAnswer(query) {
            const normalizedQuery = query.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            if (normalizedQuery.includes("chao") || normalizedQuery == "hi") return { text: "Ch√†o con! C√¥ l√† B√≠ch. Em c·∫ßn c√¥ gi√∫p g√¨ kh√¥ng?" };
            if (normalizedQuery.includes("cam on")) return { text: "Kh√¥ng c√≥ chi em nh√©! C·ªë g·∫Øng h·ªçc t·ªët nha." };
            let bestMatch = null, maxScore = 0;
            const sourceData = fullQuestionBank.length > 0 ? fullQuestionBank : (questions.length > 0 ? questions : fallbackQuestions);
            for (const item of sourceData) {
                const normalizedQ = item.q.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                let score = 0;
                const keywords = normalizedQuery.split(' ');
                keywords.forEach(word => { if (word.length > 1 && normalizedQ.includes(word)) score++; });
                if (score > maxScore) { maxScore = score; bestMatch = item; }
            }
            if (bestMatch && maxScore >= 2) { 
                const correctAns = bestMatch.opts[bestMatch.a];
                let explanation = bestMatch.expl ? bestMatch.expl : "Ki·∫øn th·ª©c n√†y r·∫•t quan tr·ªçng, em nh·ªõ k·ªπ nh√©.";
                const praises = ["C√¢u h·ªèi r·∫•t hay!", "C√¥ r·∫•t khen ng·ª£i tinh th·∫ßn h·ªçc t·∫≠p c·ªßa em!", "ƒê√¢y l√† m·ªôt c√¢u h·ªèi hay v·ªÅ bi·ªÉn, ƒë·∫£o qu√™ h∆∞∆°ng", "C√¥ s·∫Ω h·ªó tr·ª£ em c√¢u h·ªèi n√†y!"];
                const randomPraise = praises[Math.floor(Math.random() * praises.length)];
                const html = `<b>C√¥ B√≠ch:</b> ${randomPraise}<br><br>‚úÖ <b>ƒê√°p √°n:</b> <span style="color:#0091ea; font-weight:bold">${correctAns}</span><br><br>üìñ <b>Ki·∫øn th·ª©c:</b> ${explanation}<br><br>"C√¥ s·∫Ω lu√¥n ƒë·ªìng h√†nh h·ªó tr·ª£ em, ch√∫ng ta v·ªõi c√¢u h·ªèi ti·∫øp theo n√†o!" üí™`;
                return { text: html };
            } else { 
                return { text: "<b>C√¥ B√≠ch:</b> C√¢u n√†y c√¥ ch∆∞a t√¨m th·∫•y trong ng√¢n h√†ng ƒë·ªÅ. Em th·ª≠ ki·ªÉm tra l·∫°i ch√≠nh t·∫£ xem sao nh√©." }; 
            }
        }

        function renderStats(d) {
            document.getElementById('s-visits').innerText = (d.visits || 0).toLocaleString();
            document.getElementById('s-schools').innerText = (d.schools || 0).toLocaleString();
            document.getElementById('s-exams').innerText = (d.exams || 0).toLocaleString();
            
            const safeCities = Array.isArray(d.top_cities) ? d.top_cities : [];
            const safeSchools = Array.isArray(d.top_schools) ? d.top_schools : [];
            const safeStudents = Array.isArray(d.top_students) ? d.top_students : [];
            const topStudents = safeStudents; 

            const fill = (id, arr, type) => { 
                let h = ''; 
                if (arr.length > 0) {
                    arr.forEach((i, idx) => {
                        let rankClass = idx === 0 ? 'rank-1' : idx === 1 ? 'rank-2' : idx === 2 ? 'rank-3' : 'rank-other';
                        h += `<tr class="${rankClass}"><td style="width:20px"><span class="rank-badge">#${idx+1}</span></td><td>${type=='stu'?i.name+'<br><small style="color:#777">'+i.school+'</small>':i.name}</td><td style="text-align:right;font-weight:bold">${type=='stu'?i.score+'/10':i.count}</td></tr>`;
                    });
                }
                document.getElementById(id).innerHTML = h || '<tr><td colspan="3" style="text-align:center; padding:15px; color:#999; font-style:italic">ƒêang c·∫≠p nh·∫≠t d·ªØ li·ªáu...</td></tr>'; 
            };
            
            fill('t-cities', safeCities); 
            fill('t-schools', safeSchools); 
            fill('t-students', topStudents, 'stu');
        }

        function startTrial() { startExam(true); }

        function cleanName(str) { return str.toLowerCase().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '); }
        function cleanClass(str) {
            let numMatch = str.match(/\d+/);
            let num = numMatch ? parseInt(numMatch[0]) : 0; 
            let char = str.replace(/[^a-zA-Z]/g, "").toUpperCase(); 
            if (num === 0 && char === "") return "L·ªõp Kh√¥ng r√µ"; 
            if (num === 0) return `L·ªõp ${char}`; 
            if (char === "") return `L·ªõp ${num}`; 
            return `L·ªõp ${num}${char}`; 
        }
        function cleanWard(str) { return str.trim().replace(/(?:^|\s)\S/g, function(a) { return a.toUpperCase(); }).replace(/\s+/g, ' '); }
        function cleanSchool(str, clsStr) {
            let classNum = parseInt(clsStr.match(/\d+/) ? clsStr.match(/\d+/)[0] : "0");
            let prefix = "Tr∆∞·ªùng";
            if (classNum >= 1 && classNum <= 5) prefix = "Tr∆∞·ªùng Ti·ªÉu h·ªçc";
            else if (classNum >= 6 && classNum <= 9) prefix = "Tr∆∞·ªùng THCS";
            else if (classNum >= 10 && classNum <= 12) prefix = "Tr∆∞·ªùng THPT";
            let clean = str.toLowerCase();
            const removeWords = ["tr∆∞·ªùng", "ti·ªÉu h·ªçc", "thcs", "thpt", "th ", "c·∫•p 1", "c·∫•p 2", "c·∫•p 3"];
            removeWords.forEach(word => { let re = new RegExp(`\\b${word}\\b`, 'gi'); clean = clean.replace(re, ""); });
            clean = clean.trim().replace(/(?:^|\s)\S/g, function(a) { return a.toUpperCase(); });
            clean = clean.replace(/\s+/g, ' '); 
            return `${prefix} ${clean}`;
        }

        function startExam(trial) {
            if (!trial) {
                const nameIn = document.getElementById('u-name').value;
                const classIn = document.getElementById('u-class').value;
                const wardIn = document.getElementById('u-ward').value; 
                const schoolIn = document.getElementById('u-school').value;
                // L·∫§Y GI√Å TR·ªä T·ª™ SELECT
                const cityIn = document.getElementById('u-city').value;
                
                if (!nameIn || !classIn || !wardIn || !schoolIn || !cityIn) {
                    alert("Vui l√≤ng ƒëi·ªÅn ƒë·ªß: H·ªç t√™n, L·ªõp, Tr∆∞·ªùng, X√£/Ph∆∞·ªùng v√† CH·ªåN T·ªânh/TP");
                    return;
                }
                
                userInfo = { 
                    name: cleanName(nameIn), 
                    userClass: cleanClass(classIn),
                    ward: cleanWard(wardIn), 
                    school: cleanSchool(schoolIn, classIn), 
                    city: cityIn // ƒê√É L√Ä GI√Å TR·ªä CHU·∫®N T·ª™ DROPDOWN
                };
            }
            
            if (fullQuestionBank.length > 0) {
                questions = fullQuestionBank.sort(() => 0.5 - Math.random()).slice(0, 10);
            } else if (questions.length === 0) {
                questions = fallbackQuestions.sort(() => 0.5 - Math.random()).slice(0, 10);
            }
            
            isTrial = trial; score = 0; curIdx = 0; chatCount = 0;
            startTime = new Date().getTime(); 

            document.getElementById('landing-page').style.display = 'none';
            document.getElementById('reg-overlay').style.display = 'none';
            document.getElementById('quiz-view').style.display = 'block';
            document.getElementById('mode-label').innerText = trial ? "THI TH·ª¨" : "";
            document.getElementById('chat-window').style.display = 'none'; 
            renderQ();
        }

        function renderQ() {
            if (curIdx >= 5) document.getElementById('chatbot-widget').style.display = 'block';
            else document.getElementById('chatbot-widget').style.display = 'none';
            const q = questions[curIdx];
            document.getElementById('q-idx').innerText = curIdx + 1;
            document.getElementById('q-txt').innerText = q.q;
            const area = document.getElementById('options-area');
            area.innerHTML = ''; userAns = null;
            q.opts.forEach((opt, idx) => {
                const btn = document.createElement('div');
                btn.className = 'option-btn';
                btn.innerText = opt;
                btn.onclick = () => { userAns = idx; document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); }
                area.appendChild(btn);
            });
        }

        async function nextQ() {
            if (userAns === null) return alert("Ch·ªçn ƒë√°p √°n ƒëi b·∫°n!");
            if (userAns === questions[curIdx].a) score++;
            curIdx++;
            if (curIdx < 10) renderQ();
            else {
                document.getElementById('quiz-view').style.display = 'none';
                document.getElementById('chatbot-widget').style.display = 'none'; 
                document.getElementById('loader').style.display = 'flex';
                
                var endTime = new Date().getTime();
                var duration = Math.floor((endTime - startTime) / 1000); 

                if (!isTrial) await callAPI("submit", { ...userInfo, score: score, duration: duration });
                
                setTimeout(() => {
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('result-view').style.display = 'block';
                    document.getElementById('score-txt').innerText = score;
                    if (isTrial) {
                        document.getElementById('msg-txt').innerHTML = "<h3>Ho√†n th√†nh b√†i thi th·ª≠.</h3>"; 
                    } else { 
                        let finalRank = "CH∆ØA ƒê·∫†T";
                        let message = "";
                        if (score >= 8) {
                            if (chatCount > 3) {
                                finalRank = "HO√ÄN TH√ÄNH";
                                message = `<h3 style="color:blue">Em ƒë·∫°t ƒëi·ªÉm cao nh∆∞ng do d√πng tr·ª£ gi√∫p > 3 l·∫ßn n√™n x·∫øp lo·∫°i: HO√ÄN TH√ÄNH.</h3>`;
                            } else {
                                finalRank = "XU·∫§T S·∫ÆC";
                                message = `<h3 style="color:green">Ch√∫c m·ª´ng! Em ƒë√£ ho√†n th√†nh XU·∫§T S·∫ÆC cu·ªôc thi.</h3>`;
                            }
                        } else if (score >= 5) {
                            finalRank = "HO√ÄN TH√ÄNH";
                            message = `<h3 style="color:blue">Ch√∫c m·ª´ng! Em ƒë√£ HO√ÄN TH√ÄNH cu·ªôc thi.</h3>`;
                        } else {
                            message = `<h3 style="color:red">Ch∆∞a ƒë·∫°t y√™u c·∫ßu nh·∫≠n ch·ª©ng nh·∫≠n.</h3>`;
                        }
                        document.getElementById('msg-txt').innerHTML = message;
                        if (finalRank !== "CH∆ØA ƒê·∫†T") drawCert(finalRank);
                    }
                }, 1500); 
            }
        }

        function drawCert(rank) {
            const canvas = document.getElementById('certCanvas');
            const ctx = canvas.getContext('2d');
            
            const paintContent = async () => {
                canvas.width = preloadedCert.naturalWidth; 
                canvas.height = preloadedCert.naturalHeight;
                ctx.drawImage(preloadedCert, 0, 0); 
                const w = canvas.width; const h = canvas.height;
                
                try { await document.fonts.load('400 100px "Great Vibes"', userInfo.name); } catch(e) {}
                ctx.textAlign = 'center';
                ctx.font = "400 100px 'Great Vibes'"; 
                ctx.fillStyle = '#d32f2f'; 
                ctx.fillText(userInfo.name, w / 2, h * 0.42);

                const textWidth = ctx.measureText(userInfo.name).width;
                ctx.beginPath();
                ctx.moveTo(w/2 - textWidth/2 - 20, h * 0.43 + 20);
                ctx.lineTo(w/2 + textWidth/2 + 20, h * 0.43 + 20);
                ctx.lineWidth = 3; ctx.strokeStyle = '#333'; ctx.stroke();
                ctx.beginPath(); ctx.arc(w/2 - textWidth/2 - 20, h * 0.43 + 20, 5, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(w/2 + textWidth/2 + 20, h * 0.43 + 20, 5, 0, Math.PI*2); ctx.fill();

                try { await document.fonts.load('700 35px "Roboto"'); } catch(e) {}
                ctx.font = "700 35px 'Roboto'"; 
                ctx.fillStyle = '#002855'; 
                const fullInfoStr = `${userInfo.userClass} ‚Äì ${userInfo.school} ‚Äì ${userInfo.city}`;
                ctx.fillText(fullInfoStr, w / 2, h * 0.50);
                
                ctx.font = "400 35px 'Roboto'";
                const resultText = `ƒê√£ ho√†n th√†nh ${rank === "XU·∫§T S·∫ÆC" ? "xu·∫•t s·∫Øc" : ""} cu·ªôc thi tr·ª±c tuy·∫øn "Em y√™u bi·ªÉn, ƒë·∫£o qu√™ h∆∞∆°ng"`;
                ctx.fillStyle = '#002855'; 
                ctx.fillText(resultText, w / 2, h * 0.55);
                ctx.fillText("do ƒêo√†n thanh ni√™n c·ªông s·∫£n H·ªì Ch√≠ Minh, H√†nh tr√¨nh s·ªë Vi·ªát Nam My Love ph·ªëi h·ª£p t·ªï ch·ª©c", w / 2, h * 0.59);

                try {
                    const url = canvas.toDataURL("image/png");
                    const finalImg = document.getElementById('cert-final');
                    finalImg.src = url;
                    finalImg.style.display = 'block';
                    const btn = document.getElementById('down-btn'); 
                    btn.href = url; 
                    btn.download = `ChungNhan_${userInfo.name.replace(/\s+/g, '_')}.png`; 
                    btn.style.display = 'inline-block';
                } catch (err) {
                    canvas.style.display = 'block';
                    document.getElementById('msg-txt').innerHTML += "<br><span style='color:#e65100; font-size:0.9rem'>L∆∞u √Ω: Vui l√≤ng Ch·ª•p m√†n h√¨nh ƒë·ªÉ l∆∞u ch·ª©ng nh·∫≠n.</span>";
                }
            };

            if (preloadedCert.complete && preloadedCert.naturalHeight !== 0) {
                paintContent();
            } else {
                preloadedCert.onload = paintContent;
            }
        }
    </script>
</body>
</html>